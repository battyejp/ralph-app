# Progress Log - Customer Creation Feature

## Codebase Patterns

- **Environment**: Node.js/npm not on host - all commands via `docker-compose exec frontend`
- **Frontend Framework**: Next.js 14 with App Router (not Pages Router)
- **UI Components**: shadcn/ui manually created in src/components/ui/
- **API Client**: Singleton pattern in src/lib/api/customerApi.ts
- **Testing**: Jest with >80% coverage requirement
- **Suspense Required**: Components using useSearchParams() must be wrapped in Suspense
- **Toast System**: useToast hook with 'default' and 'destructive' variants
- **Responsive Pattern**: Both desktop and mobile views rendered, hidden/shown with Tailwind md: breakpoint
- **Backend**: .NET 10 with EF Core 9.0, auto-migrations on startup

- **Backend Testing**: Tests run via `docker run --rm -v "D:\code\Github\battyejp\ralph-app\src\backend:/src" -w //src mcr.microsoft.com/dotnet/sdk:10.0 dotnet test`
- **Repository Pattern**: Use EmailExistsAsync for duplicate checks, EmailExistsAsync returns false for soft-deleted records

- **Jest Fake Timers Pattern**: When testing async code with retries, use fake timers and set up the expectation before running timers:
  ```typescript
  const expectation = expect(resultPromise).rejects.toMatchObject({...});
  await jest.runAllTimersAsync();
  await expectation;
  ```

---

## 2026-01-16 - US-003
- **What was implemented**: Created CustomerForm component with comprehensive validation
- **Files created**:
  - `src/frontend/src/components/CustomerForm.tsx` - Form component with:
    - Name (required) and Email (required) fields with client-side validation
    - Phone and Address optional fields
    - Inline error messages with red text styling
    - Client-side validation on blur and submit
    - Server-side validation error display
    - Loading/disabled state during API call
    - onSuccess callback prop
    - Responsive stacked layout
    - Full accessibility (aria-invalid, aria-describedby, role="alert")
  - `src/frontend/src/components/CustomerForm.test.tsx` - 37 comprehensive tests covering:
    - Rendering (fields, buttons, placeholders, required markers)
    - User input for all fields
    - Client-side validation (blur, submit, error clearing)
    - Form submission (with/without optional fields, trimming, callback)
    - Loading state (button disabled, inputs disabled, text changes)
    - Server-side error handling (field errors, duplicate email, generic errors)
    - Accessibility (aria attributes, alert roles)
    - Responsive design
    - Edge cases (empty optionals, whitespace handling)
- **Learnings for future iterations**:
  - Use `touched` state pattern to show errors only after field interaction
  - Email validation regex: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
  - Server errors come with field names in PascalCase (e.g., "Name", "Email") - convert to lowercase for matching
  - For non-field-specific API errors (like 409 duplicate), display in email field as fallback
  - Mock ApiError class in tests when mocking customerApi module
  - Component is ready for integration in US-005 (modal) and US-006 (dedicated page)
  - Coverage: 96.8% statements, 80% branches, 90.47% functions, 96.59% lines

---

## 2026-01-16 - US-002
- **What was implemented**: Added createCustomer method to frontend API client
- **Files changed**:
  - `src/frontend/src/lib/api/types.ts` - Added CreateCustomerData interface
  - `src/frontend/src/lib/api/customerApi.ts` - Added createCustomer method and postWithErrorHandling helper, added 409 handling to getUserFriendlyErrorMessage
  - `src/frontend/src/lib/api/customerApi.test.ts` - Added 15 comprehensive tests for createCustomer
- **Learnings for future iterations**:
  - POST requests need a separate helper method (postWithErrorHandling) similar to fetchWithErrorHandling for GET
  - 409 Conflict should be handled with user-friendly message and non-retryable flag
  - When testing retryable errors, must use Jest fake timers to avoid timeout issues
  - Pre-existing tests without fake timers may timeout - this is a known issue to fix in future
  - Coverage for new code is more important than overall coverage when other components have pre-existing gaps

---

## 2026-01-16 - US-001
- **What was implemented**: Added duplicate email handling to CreateCustomer endpoint
- **Files changed**:
  - `src/backend/CustomerApi/Repositories/ICustomerRepository.cs` - Added EmailExistsAsync method signature
  - `src/backend/CustomerApi/Repositories/CustomerRepository.cs` - Implemented EmailExistsAsync method
  - `src/backend/CustomerApi/Controllers/CustomersController.cs` - Added duplicate email check returning 409 Conflict
  - `src/backend/CustomerApi.Tests/Repositories/CustomerRepositoryTests.cs` - Added EmailExistsAsync tests
  - `src/backend/CustomerApi.Tests/Controllers/CustomersControllerTests.cs` - Added duplicate email tests, updated existing tests
- **Learnings for future iterations**:
  - Backend runtime container doesn't have SDK - use separate docker run with SDK image for build/test
  - EmailExistsAsync uses `!c.IsDeleted` filter to allow reusing emails from soft-deleted customers
  - All existing CreateCustomer tests needed EmailExistsAsync mock setup after adding the check
  - 409 Conflict is the correct HTTP status for duplicate resource creation attempts

---

